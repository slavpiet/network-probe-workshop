---
- name: "Step 3: Deploy Kibana"
  hosts: all
  become: yes
  
  vars:
    # Kibana variables
    base_directory: "/opt/network-sensors"
    cert_directory: "{{ base_directory }}/certificates"
    kibana_version: "9.0.0"
    kibana_port: 5601
    elasticsearch_http_port: 9200
    elasticsearch_password: "ChangeMe123!"
    server_hostname: "sensor-node-01"
  
  tasks:
    - name: Display Kibana deployment phase
      debug:
        msg:
          - "=========================================="
          - "PHASE 3: KIBANA DEPLOYMENT"
          - "=========================================="
          - "Version: {{ kibana_version }}"
          - "Port: {{ kibana_port }}"
          - "SSL/TLS: Enabled"
          - "Connecting to Elasticsearch: localhost:{{ elasticsearch_http_port }}"
          - "=========================================="
      tags: ['always']

    - name: Include kibana role
      import_role:
        name: kibana
      tags: ['kb']

    - name: Wait for Kibana to be ready
      wait_for:
        host: localhost
        port: "{{ kibana_port }}"
        delay: 15
        timeout: 300
        msg: "Kibana did not start in time"
      tags: ['kb', 'verify']

    - name: Display Kibana access information
      debug:
        msg:
          - "=========================================="
          - "PHASE 3: COMPLETED"
          - "=========================================="
          - "Kibana is running!"
          - "URL: https://localhost:{{ kibana_port }}"
          - "Username: elastic"
          - "Password: {{ elasticsearch_password }}"
          - ""
          - "Docker Compose: {{ base_directory }}/kibana/docker-compose.yml"
          - ""
          - "Access Kibana from browser (use SSH tunnel if remote):"
          - "  ssh -L {{ kibana_port }}:localhost:{{ kibana_port }} sonda-dev@your-server"
          - "  Then open: https://localhost:{{ kibana_port }}"
          - "  (Accept self-signed certificate warning)"
          - "=========================================="
      tags: ['always']
